<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Journal</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <!-- external libs from cdnjs -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

    <!-- PivotTable.js libs from ../dist -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.js"></script>

    <script src='config.js'></script>
    <script src='_icescrum_api_token.js'></script>
    <style>
        #spinner {
            width: 80px;
            height: 80px;
            left: 0px;
            top: 0px;
            opacity: 1;
        }

        .code {
            font-family: "Courier New";
            font-weight: bolder;
            padding: 4px;
            margin: 2px;
        }
    </style>
</head>
<body>
<div class="pl-5 m-2 mt-4 text-center">
    <h1>Projet <span id="spnProjName">?</span></h1>
    <div class="small">Unité de temps: <span id="spnTUnit"></span></div>
    <div id="divBadConfig" class="container d-none text-left">
        <p>Cette page est mal configurée, voici ce que vous devez vérifier:</p>
        <ol>
            <li>
                Le fichier <span class="code">config.js</span> initialise correctement les trois variables suivantes
                <ul>
                    <li><span class="code">projectId = 'XXXXXXX'</span> doit contenir le code Icescrum de votre projet. Vous la trouvez dans l'url quand vous êtes sur votre projet dans Icescrum</li>
                    <li><span class="code">team = ["Pierrette", "Paul", "Jean"]</span> la liste des prénoms des personnes participant au projet</li>
                    <li><span class="code">timeUnit = "min"</span> l'unité de temps que vous utilisez avec le TimeTracking</li>
                </ul>
            </li>
            <li>
                Vous avez créé le fichier <span class="code">_icescrum_api_token.js</span> qui contient votre token d'API Icescrum<br>
                <span class="code">var iceScrumToken = '91030e0ea9a9ab58cbacbf399de65ff21'</span><br>
                Vous retrouvez votre token dans votre profil ("My Account") sous l'onglet 'API token'<br>
                <span style="font-weight: bolder">Attention: </span> veillez à ce que ce fichier soit exclu du système de versionning !...
            </li>
        </ol>
    </div>
    <div id="spnLoading">
        <img src="https://media2.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif" alt="Loading GIF by Mashable" id="spinner"> Chargement de données depuis IceScrum...
    </div>
</div>
<div id="divContent" class="d-none">

    <div id="output" style="margin: 30px;"></div>
    <div style="font-size: x-small">Powered by <a href="https://github.com/nicolaskruchten/pivottable">pivottable.js</a> de Nicolas Kruchten</div>

</div>
</body>
</html>
<script>

    // ============ Initialization =================
    var months = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jui', 'Aou', 'Sep', 'Oct', 'Nov', 'Déc']
    var projectStories // globals :-( holding all stories of the project
    var projectSprints

    // Configuration check
    if (typeof (iceScrumToken) !== 'undefined' && typeof (projectId) !== 'undefined' && typeof (timeUnit) !== 'undefined')
    {
        var API_base_url = 'https://icescrum.cpnv.ch/ws/project/' + projectId
        loadData()
    } else
    {
        divBadConfig.classList.remove('d-none')
        spnLoading.classList.add('d-none')
    }

    // Unit in title
    spnTUnit.innerText = timeUnit

    // Project name
    fetch(API_base_url + '/?icescrum-token=' + iceScrumToken).then(function (response) {
        return response.json()
    }).then(function (data) {
        spnProjName.innerText = data.name
    })

    // Business stuff....
    function showData(table, tasks)
    {
        table.innerHTML = ''
        tasks.forEach(function (task) {
            let d = new Date(task.lastUpdated)
            date = d.getDate() + ' ' + months[d.getMonth()] + ' ' + d.getFullYear() + ' ' + d.getHours() + ':' + d.getMinutes()
            switch (task.type)
            {
                case 10:
                    storyName = 'Urgente'
                    break;
                case 11:
                    storyName = 'Récurrente'
                    break;
                default:
                    storyName = task.parentStory.name
            }

            tr = document.createElement('tr')
            c = document.createElement('td') // Story
            c.innerText = storyName
            tr.appendChild(c)
            c = document.createElement('td') // Task
            c.innerText = task.name
            tr.appendChild(c)
            c = document.createElement('td') // Date
            c.innerText = date
            tr.appendChild(c)
            c = document.createElement('td') // Time spent
            c.innerText = task.spent
            tr.appendChild(c)
            c = document.createElement('td') // Filter-specific data
            c.innerText = task.data
            tr.appendChild(c)
            table.appendChild(tr)
        })
    }

    function loadData()
    {
        let stories = [] // the stories of the project
        stories[10] = {name: '(Urgentes)', tasks: []}
        stories[11] = {name: '(Récurrentes)', tasks: []}
        let sprints = [] // the sprints of the project
        // First get all sprints
        fetch(API_base_url + '/sprint?icescrum-token=' + iceScrumToken).then(function (response) {
            return response.json()
        }).then(function (data) {
            data.forEach(function (sprint) {
                sprints[sprint.id] = {number: sprint.orderNumber, release: sprint.parentRelease.name}
            })
            projectSprints = sprints
        }).then(function () { // get stories
            fetch(API_base_url + '/story?icescrum-token=' + iceScrumToken).then(function (response) {
                return response.json()
            }).then(function (data) {
                data.forEach(function (story) {
                    stories[story.id] = {name: story.name, type: story.type, effort: story.effort, value: story.value, tasks: []}
                })
            }).then(function () { // get all tasks
                fetch(API_base_url + '/task?icescrum-token=' + iceScrumToken).then(function (response) {
                    return response.json()
                }).then(function (data) {
                    data.forEach(function (task) {
                        if (task.doneDate) {
                            if (task.type == 10 || task.type == 11) // task is urgent or recurrent
                            {
                                stories[task.type].tasks.push(task)
                            } else // it's linked to a user story
                            {
                                if (typeof (stories[task.parentStory.id]) != 'undefined') // it is one of the stories we kept for display
                                {
                                    stories[task.parentStory.id].tasks.push(task)
                                }
                            }
                        }
                    })
                }).then(function () { // show tasks
                    var pivotdata = extractpivotdata(stories)
                    $("#output").pivotUI(pivotdata,
                        {
                            rows: ["date", "story", "task"],
                            cols: ["owner"]
                        }
                    );
                    projectStories = stories
                    spnLoading.classList.add('d-none')
                    divContent.classList.remove('d-none')
                })
            })
        }).catch(function (erreur) {
            alert("Erreur de connexion au serveur IceScrum\n\nSi vous pouvez atteindre icescrum.cpnv.ch avec votre navigateur, alors c'est probablement que votre token est pourri")
            window.close()
        })
    }

    function extractpivotdata(stories)
    {
        res = []
        stories.forEach(function (story) {
            story.tasks.forEach(function (task) {
                if (task.tags.length == 0) {
                    res.push({
                        task: task.name,
                        story: story.name,
                        release: task.sprint.parentRelease ? task.sprint.parentRelease.name : '?',
                        sprint: task.sprint.index,
                        owner: task.responsible ? task.responsible.firstName : '',
                        initial_planned_time: task.initial,
                        spent_time: task.spent,
                        type: story.type == 0 ? 'user' : (story.type == 3 ? 'tech' : 'rec/urg'),
                        effort: story.effort,
                        value: story.value,
                        date: task.doneDate ? task.doneDate.substring(0, 10) : ''
                    })
                } else {
                    task.tags.forEach(function (tag) {
                        res.push({
                            task: task.name,
                            story: story.name,
                            release: task.sprint.parentRelease ? task.sprint.parentRelease.name : '?',
                            sprint: task.sprint.index,
                            owner: task.responsible ? task.responsible.firstName : '',
                            initial_planned_time: task.initial,
                            spent_time: task.spent,
                            type: story.type == 0 ? 'user' : (story.type == 3 ? 'tech' : 'rec/urg'),
                            effort: story.effort,
                            tag: tag,
                            value: story.value,
                            date: task.doneDate ? task.doneDate.substring(0, 10) : ''
                        })
                    })
                }
            })
        })
        return res
    }

</script>
