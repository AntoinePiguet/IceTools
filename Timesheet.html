<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Journal</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <!-- external libs from cdnjs -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

    <!-- PivotTable.js libs from ../dist -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.23.0/pivot.min.js"></script>

    <script src='_icescrum_api.js'></script>
    <style>
        #spinner {
            width: 80px;
            height: 80px;
            left: 0px;
            top: 0px;
            opacity: 1;
        }

        .code {
            font-family: "Courier New";
            font-weight: bolder;
            padding: 4px;
            margin: 2px;
        }
    </style>
</head>
<body>
<div class="pl-5 m-2 mt-4 text-center">
    <h1 id="spnProjName"></h1>
    <div id="divBadConfig" class="container d-none text-left m-5 p-3 bg-warning">
        <h3>Cette page est mal configurée!!</h3>
        <p>Vérifiez que vous avez créé le fichier <span class="code">_icescrum_api.js</span> qui contient:
            <ol>
                <li>
                    Votre token d'accès à l'API Icescrum.
                    <span class="code">var iceScrumToken = '91030e0ea9a9ab58...'</span>
        <p class="small text-secondary">Vous générez ou retrouvez votre token dans votre profil ("My Account") sous l'onglet 'API token'</p>
        </li>
        <li>
            Le code Icescrum de votre projet:
            <span class="code">projectId = 'XXXXXXX'</span>
            <p class="small text-secondary">Vous le trouvez dans l'url quand vous êtes sur votre projet dans Icescrum</p>
        </li>
        </ol>
        <p>Veillez également à ce que le fichier <span class="code">_icescrum_api.js</span>:</p>
        <ul>
            <li>Soit exclu du système de versionning</li>
            <li>Se trouve dans le même dossier que cette page</li>
        </ul>
    </div>
    <div id="spnLoading">
        <img src="https://media2.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif" alt="Loading GIF by Mashable" id="spinner"> Chargement de données depuis IceScrum...
    </div>
</div>
<div id="divContent" class="d-none">

    <div id="output" style="margin: 30px;"></div>
    <div style="font-size: x-small">Powered by l'excellentissime <a href="https://github.com/nicolaskruchten/pivottable">pivottable.js</a> de Nicolas Kruchten</div>

</div>
</body>
</html>
<script>

    // ============ Initialization =================
    var months = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jui', 'Aou', 'Sep', 'Oct', 'Nov', 'Déc']
    var projectStories // globals :-( holding all stories of the project

    // Configuration check
    if (typeof (iceScrumToken) !== 'undefined' && typeof (projectId) !== 'undefined')
    {
        var API_base_url = 'https://icescrum.cpnv.ch/ws/project/' + projectId
        loadData()
    } else
    {
        divBadConfig.classList.remove('d-none')
        spnLoading.classList.add('d-none')
    }

    // Project name
    fetch(API_base_url + '/?icescrum-token=' + iceScrumToken).then(function (response) {
        return response.json()
    }).then(function (data) {
        spnProjName.innerText = 'Projet ' + data.name
    })

    function loadData()
    {
        let stories = [] // the stories of the project
        stories[10] = {name: '(Urgentes)', tasks: []}
        stories[11] = {name: '(Récurrentes)', tasks: []}
        fetch(API_base_url + '/story?icescrum-token=' + iceScrumToken).then(function (response) {
            return response.json()
        }).then(function (data) {
            data.forEach(function (story) {
                stories[story.id] = {name: story.name, type: story.type, effort: story.effort, value: story.value, tasks: []}
            })
        }).then(function () { // get all tasks
            fetch(API_base_url + '/task?icescrum-token=' + iceScrumToken).then(function (response) {
                return response.json()
            }).then(function (data) {
                data.forEach(function (task) {
                    if (task.doneDate)
                    {
                        if (task.type == 10 || task.type == 11) // task is urgent or recurrent
                        {
                            stories[task.type].tasks.push(task)
                        } else // it's linked to a user story
                        {
                            if (typeof (stories[task.parentStory.id]) != 'undefined') // it is one of the stories we kept for display
                            {
                                stories[task.parentStory.id].tasks.push(task)
                            }
                        }
                    }
                })
            }).then(function () { // show tasks
                var pivotdata = extractpivotdata(stories)
                $("#output").pivotUI(pivotdata,
                    {
                        rows: ["date", "story", "task"],
                        cols: ["owner"]
                    }
                );
                projectStories = stories
                spnLoading.classList.add('d-none')
                divContent.classList.remove('d-none')
            })
        }).catch(function (erreur) {
            alert("Erreur de connexion au serveur IceScrum\n\nSi vous pouvez atteindre icescrum.cpnv.ch avec votre navigateur, alors c'est probablement que votre token est pourri")
            window.close()
        })
    }

    /**
     * Provide a 2D array of all tasks of the project. This array is meant to be fed into the pivottable plugin (see credit)
     * @param stories
     * @returns {[]}
     */
    function extractpivotdata(stories)
    {
        res = []
        stories.forEach(function (story) {
            story.tasks.forEach(function (task) {
                if (task.tags.length == 0)
                { // no tags -> one row without column tag for this task
                    res.push({
                        task: task.name,
                        story: story.name,
                        release: task.sprint.parentRelease ? task.sprint.parentRelease.name : '?',
                        sprint: task.sprint.index,
                        owner: task.responsible ? task.responsible.firstName : '',
                        initial_planned_time: task.initial,
                        spent_time: task.spent,
                        type: story.type == 0 ? 'user' : (story.type == 3 ? 'tech' : 'rec/urg'),
                        effort: story.effort,
                        value: story.value,
                        date: task.doneDate ? task.doneDate.substring(0, 10) : ''
                    })
                } else
                {
                    task.tags.forEach(function (tag) { // one row for each tag for this task
                        res.push({
                            task: task.name,
                            story: story.name,
                            release: task.sprint.parentRelease ? task.sprint.parentRelease.name : '?',
                            sprint: task.sprint.index,
                            owner: task.responsible ? task.responsible.firstName : '',
                            initial_planned_time: task.initial,
                            spent_time: task.spent,
                            type: story.type == 0 ? 'user' : (story.type == 3 ? 'tech' : 'rec/urg'),
                            effort: story.effort,
                            tag: tag,
                            value: story.value,
                            date: task.doneDate ? task.doneDate.substring(0, 10) : ''
                        })
                    })
                }
            })
        })
        return res
    }

</script>
